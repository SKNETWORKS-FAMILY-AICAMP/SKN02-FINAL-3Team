<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Listening Page</title>

    <link href="{% static 'meeting/bootstrap/bootstrap.css' %}" rel="stylesheet" media="screen">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="{% static 'meeting/css/recording.css' %}" media="screen">
</head>
<body>
<div class="main-container">
    <div class="listening-container">
        <img src="{% static 'images/listening.gif' %}" alt="" height="70px">
        <div class="listening-text">&nbsp;&nbsp;Listening...</div>
    </div>

    <button id="end-button" data-bs-toggle="modal" data-bs-target="#finishModal">회의 종료</button>

    <!-- 모달 -->
    <div class="modal fade" id="finishModal" tabindex="-1" aria-labelledby="finishModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title" id="finishModalLabel">회의 종료</h3>
                </div>
                <div class="modal-body">
                    <form>
                        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
                        <div class="mb-3">
                            <label for="title_input_element" class="form-label">제목:</label>
                            <input type="text" class="form-control" id="title_input_element" name="title_input_element" placeholder="제목 입력">
                        </div>
                        <div class="mb-3">
                            <label for="attendent_input_element" class="form-label">참석자:</label>
                            <div id="attendent-input-container">
                                <input type="text" class="form-control" id="attendent_input_element" placeholder="이메일 입력 후 쉼표로 구분">
                                <div id="email-buttons" class="mt-2"></div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="checker_input_element" class="form-label">확인자:</label>
                            <input type="text" class="form-control" id="checker_input_element" placeholder="닉네임 입력">
                        </div>
                        <p class="modal-text">
                            회의를 저장하시겠습니까?<br> 저장하지 않고 나가면 회의가 저장되지 않습니다.
                        </p>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary">예</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="close-button">아니요</button>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="{% static 'meeting/bootstrap/bootstrap.bundle.js' %}"></script>

<script>
    <!--모달에서 아니오을 누르면 main화면으로 넘어가는 코드 구현-->
    document.getElementById('close-button').addEventListener('click', function() {
        // 원하는 URL로 이동
        window.location.href = '{% url "main" %}'; // 여기에 원하는 링크를 입력
    });

    let mediaRecorder;
    let audioChunks = [];
    let audioBlob; // 전역에서 사용하기 위해 미리 선언

    document.addEventListener('DOMContentLoaded', async function() {
        await startRecording();
    });

    async function startRecording() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);

            mediaRecorder.ondataavailable = event => {
                audioChunks.push(event.data);
            };

            mediaRecorder.onstop = async () => {
                audioBlob = new Blob(audioChunks, { type: 'audio/wav' }); // Blob을 전역 변수로 저장
                audioChunks = [];
            };

            mediaRecorder.start();
        } catch (error) {
            console.error('오디오 녹음에 실패했습니다:', error);
        }
    }

    // "회의 종료" 버튼을 클릭하면 녹음을 멈추고 모달을 띄웁니다.
    document.getElementById('end-button').addEventListener('click', () => {
        if (mediaRecorder && mediaRecorder.state !== 'inactive') {
            mediaRecorder.stop();
        }
        // 부트스트랩 모달을 수동으로 표시
        var finishModal = new bootstrap.Modal(document.getElementById('finishModal'));
        finishModal.show();
    });

    // 참석자 이메일 입력 처리
    document.getElementById('attendent_input_element').addEventListener('keydown', function(event) {
        const input = event.target;

        if (event.key === ',') {
            event.preventDefault(); // 기본 동작 방지
            const email = input.value.trim();

            if (email) {
                // 이메일 버튼 생성
                const emailButton = document.createElement('button');
                emailButton.className = 'btn btn-outline-primary me-1 mb-1';
                emailButton.textContent = email;

                // 이메일 버튼 클릭 시 해당 이메일을 삭제할 수 있는 기능 추가
                emailButton.addEventListener('click', function() {
                    emailButton.remove();
                });

                // 버튼을 이메일 버튼 컨테이너에 추가
                document.getElementById('email-buttons').appendChild(emailButton);

                // 입력값 초기화하지 않음
                input.value = ''; // 입력 필드만 초기화
            }
        }
    });

    // 모달에서 "예" 버튼을 클릭하면 실행
    document.querySelector('.modal-footer .btn-primary').addEventListener('click', async function() {
        const formData = new FormData();
        const meetingName = document.getElementById('title_input_element').value;
        formData.append('meetingName', meetingName)

        // 참석자 이메일 수집
        const emailButtons = document.querySelectorAll('#email-buttons button');
        emailButtons.forEach(button => {
            formData.append('attendees[]', button.textContent); // 버튼의 텍스트를 이메일로 추가
        });

        formData.append('audio', audioBlob); // 오름차순으로 저장하기 위한 이름은 서버측 로직에 맡겨야 합니다.
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        try {
            const response = await fetch("{% url 'save_audio' %}", { // POST 경로를 'save_audio' 로 변경하였습니다. 실제 경로는 서버 설정에 따릅니다.
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrfToken
                }
            });

            if (response.ok) {
                console.log('녹음 파일이 성공적으로 저장되었습니다.');
                window.location.href = "{% url 'main' %}";
            } else {
                console.error('녹음 파일 저장에 실패했습니다:', response.statusText);
            }
        } catch (fetchError) {
            console.error('녹음 파일 전송 중 오류가 발생했습니다:', fetchError);
        }
    });
</script>

</body>
</html>
