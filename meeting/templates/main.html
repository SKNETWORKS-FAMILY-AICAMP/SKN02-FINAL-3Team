{% extends 'base.html' %}
{% load static %}

{% block title %}- Main{% endblock %}

{% block css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'meeting/css/main.css' %}?after" media="screen">
<link rel="stylesheet" href="{% static 'meeting/css/meeting.css' %}?after">
<link rel="stylesheet" href="{% static 'meeting/css/meeting_detail.css' %}?after" media="screen">
{% endblock %}


{% block contents %}
<div class="meeting-list">
  <!-- 드롭다운 메뉴와 검색 입력 -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <div class="dropdown">
    <button class="btn btn-light dropdown-toggle" type="button" id="dropdownMenuButton" data-bs-toggle="dropdown"
      aria-haspopup="true" aria-expanded="false">
      검색 유형 선택
    </button>
    <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
      <a class="dropdown-item" href="#" data-search-type="title">제목</a>
      <a class="dropdown-item" href="#" data-search-type="author">작성자</a>
      <a class="dropdown-item" href="#" data-search-type="date">날짜</a>
    </div>
  </div>
  <div class="input-group">
    <input type="search" id="search-input" class="form-control rounded" placeholder="검색어 입력" aria-label="Search" aria-describedby="search-addon" />
    <button type="button" class="btn btn-primary meeting-search-button">검색</button>
  </div>
</div>


  <div class="list-container" id="list-container">
    <div class="create-meeting">
      <a class="nav-link" href="{% url 'recording' %}">+ 새 회의 만들기</a>
    </div>
    <div id="list-items">
      {% for meeting in meetings %}
      <div class="list-item" onclick="toggleDetails1('{{ meeting.id }}')">
        <span class="list-item-title">{{ meeting.title }}</span>
        <span class="list-item-info">{{ meeting.started_at|date:"Y-m-d H:i" }}<br>{{ meeting.host }}</span>
      </div>
      {% endfor %}



    </div>
  </div>
  <div class="details-container" id="details">
    <h3 id="details-title">{{ meeting.title }}</h3>
    <p id="details-content">Select an item from the list to see more details here.</p>
  </div>

  <!--Modal-->
  <div class="modal fade" id="contentDetail">
    <div class="modal-dialog" id="meetingDetailModal">
      <div class="modal-content" id="contentModalHtml">
      </div>
    </div>
  </div>
</div>



{% endblock %}

{% block script %}
<script>
  let currentItem = null;

  function toggleDetails1(meeting_id) {
    const listContainer = document.getElementById('list-container');
    const detailsContainer = document.getElementById('details');
    const detailsContent = document.getElementById('details-content');
    const modalContainer = document.getElementById('contentModalHtml');

    if (currentItem === meeting_id) {
      // Hide the details if the same item is clicked again
      detailsContainer.classList.remove('open');
      listContainer.classList.remove('split-view');
      currentItem = null;
    } else {
      // Fetch the meeting details from the server
      fetch(`/meeting_summary/${meeting_id}/`)
        .then(response => response.text())
        .then(html => {
          // Show the details of the selected item
          detailsContent.innerHTML = html;
          detailsContainer.classList.add('open');
          listContainer.classList.add('split-view');
          currentItem = meeting_id;
        });
        fetch(`/meeting_detail/${meeting_id}`)
          .then(response => response.text())
          .then(html => {
            console.log(html)
            modalContainer.innerHTML = html;
          });
    }
  }



</script>




<script>
  document.addEventListener('DOMContentLoaded', function () {
    let selectedSearchType = 'title';  // 기본 검색 유형 설정

    // 드롭다운 메뉴에서 검색 유형 선택 시
    document.querySelectorAll('.dropdown-item').forEach(function (item) {
      item.addEventListener('click', function (e) {
        e.preventDefault();
        selectedSearchType = this.getAttribute('data-search-type');
        document.getElementById('dropdownMenuButton').innerText = this.innerText;
      });
    });

    // 검색 버튼 클릭 시
    document.querySelector('.meeting-search-button').addEventListener('click', function () {
      const query = document.getElementById('search-input').value.trim();

      if (!query) {
        alert('검색어를 입력해주세요.');
        return;
      }

      // AJAX 요청 보내기
      fetch('/search/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')  // CSRF 토큰 포함
        },
        body: JSON.stringify({
          'search_type': selectedSearchType,
          'query': query
        })
      })
        .then(response => response.json())
        .then(data => {
          displaySearchResults(data.meetings);
        })
        .catch(error => {
          console.error('Error:', error);
        });
    });

    // 검색 결과 표시 함수
    function displaySearchResults(meetings) {
      const listItemsContainer = document.getElementById('list-items');
      listItemsContainer.innerHTML = '';  // 기존 목록 초기화

      if (meetings.length === 0) {
        listItemsContainer.innerHTML = '<p>검색 결과가 없습니다.</p>';
        return;
      }

      meetings.forEach(meeting => {
        const meetingDiv = document.createElement('div');
        meetingDiv.classList.add('list-item');
        meetingDiv.setAttribute('onclick', `toggleDetails1('${meeting.id}')`);
        meetingDiv.innerHTML = `
          <span class="list-item-title">${meeting.title}</span>
          <span class="list-item-info">${meeting.started_at}<br>${meeting.author}</span>
        `;
        listItemsContainer.appendChild(meetingDiv);
      });
    }

    // CSRF 토큰 가져오기 함수
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          // 쿠키가 name=값 형태인지 확인
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
  });
</script>

{% endblock %}